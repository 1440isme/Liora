<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<body>
    <!-- Header Start -->
    <header th:fragment="header">
        <!-- Top Header - Tầng trên -->
        <div class="top-header">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Logo -->
                    <div class="col-auto">
                        <a class="navbar-brand" href="/" onclick="showPage('home')">
                            <img src="/admin/images/liora-white.svg" alt="Liora" height="40" class="logo-img">
                        </a>
                    </div>

                    <!-- Search Bar -->
                    <div class="col">
                        <div class="search-container">
                            <div class="position-relative">
                                <i class="mdi mdi-magnify search-icon"></i>
                                <input type="text" class="form-control search-input"
                                    placeholder="Tìm kiếm sản phẩm, thương hiệu, ...">
                            </div>
                        </div>
                    </div>

                    <!-- User & Cart -->
                    <div class="col-auto">
                        <div class="d-flex align-items-center gap-3">
                            <!-- User Account -->
                            <div id="user-section">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <!-- Cart -->
                            <button class="btn btn-cart position-relative">
                                <i class="mdi mdi-shopping-outline"></i>
                                <div class="cart-text">
                                    <div class="cart-title">GIỎ HÀNG</div>
                                </div>
                                <span
                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill cart-badge">
                                    0
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Header - Tầng dưới -->
        <div class="bottom-header" id="dynamic-bottom-header">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Categories Button -->
                    <div class="col-auto">
                        <div class="dropdown categories-dropdown">
                            <button class="btn btn-categories" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false" id="categories-button">
                                <i class="mdi mdi-menu"></i>
                                <span id="categories-button-text">Danh Mục Sản Phẩm</span>
                            </button>
                            <div class="dropdown-menu categories-menu">
                                <div class="container-fluid">
                                    <div class="row">
                                        <!-- Cột 1: Danh mục chính -->
                                        <div class="col-md-3">
                                            <div class="category-column">
                                                <div class="category-list">
                                                    <div class="category-loading">
                                                        <i class="mdi mdi-loading"></i>
                                                        Đang tải danh mục...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Cột 2: Danh mục cấp 2 & 3 (trái) -->
                                        <div class="col-md-4">
                                            <div class="category-column">
                                                <div class="subcategory-list">
                                                    <div class="category-loading">
                                                        <i class="mdi mdi-loading"></i>
                                                        Chọn danh mục để xem...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Cột 3: Danh mục cấp 2 & 3 (phải) -->
                                        <div class="col-md-5">
                                            <div class="category-column">
                                                <div class="product-list">
                                                    <div class="category-loading">
                                                        <i class="mdi mdi-loading"></i>
                                                        Chọn danh mục để xem sản phẩm...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Navigation -->


                    <!-- Dynamic Navigation Items -->
                    <div class="col" id="main-navigation">
                        <nav class="main-nav">
                            <ul class="nav-list">
                                <!-- Navigation items will be loaded dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header Bottom Loading Script -->
        <script>
            function initHeaderBottom() {
                try {
                    loadHeaderNavigationContent();
                } catch (e) {
                    console.error('Header init error:', e);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initHeaderBottom);
            } else {
                initHeaderBottom();
            }

            async function loadHeaderNavigationContent() {
                try {
                    const response = await fetch('/content/api/header-bottom');
                    const data = await response.json();

                    // Update navigation items
                    if (data.navigationItems && data.navigationItems.length > 0) {
                        const navList = document.querySelector('#main-navigation .nav-list');
                        navList.innerHTML = '';

                        // Load sub-items for each parent item
                        for (let i = 0; i < data.navigationItems.length; i++) {
                            const item = data.navigationItems[i];
                            if (item.id) {
                                try {
                                    const subResponse = await fetch(`/content/api/header-bottom/sub-items/${item.id}`);
                                    const subData = await subResponse.json();
                                    item.subItems = subData || [];
                                } catch (subError) {
                                    console.error('Error loading sub-items for', item.title, ':', subError);
                                    item.subItems = [];
                                }
                            }
                        }

                        data.navigationItems.forEach(item => {
                            const navItem = document.createElement('li');
                            navItem.className = 'nav-item';

                            if (item.linkType === 'CATEGORY' || item.isCategoryParent) {
                                // Create dropdown for categories
                                const dropdownId = `category-dropdown-${Math.random().toString(36).substr(2, 9)}`;
                                navItem.innerHTML = `
                                    <div class="nav-dropdown">
                                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="${dropdownId}">
                                            ${item.title.toUpperCase()}
                                            <i class="mdi mdi-chevron-down dropdown-arrow"></i>
                                        </a>
                                        <ul class="dropdown-menu category-dropdown-menu" aria-labelledby="${dropdownId}">
                                            <li><a class="dropdown-item" href="#">Đang tải danh mục con...</a></li>
                                        </ul>
                                    </div>
                                `;

                                // Load sub-categories for this category
                                loadSubCategories(navItem, item);
                            } else {
                                // Create regular button for other items
                                const navLink = document.createElement('a');

                                // Determine URL based on link type
                                let href = '#';
                                if (item.linkType === 'EXTERNAL') {
                                    href = item.url || '#';
                                } else if (item.linkType === 'PAGE') {
                                    // Normalize to /content/page/{slug}
                                    const raw = (item.url || '').toString();
                                    const slug = raw
                                        .replace(/^\/content\/page\//, '')
                                        .replace(/^\//, '');
                                    href = slug ? `/content/page/${slug}` : '#';
                                } else if (item.linkType === 'INTERNAL') {
                                    href = item.url || '#';
                                }

                                navLink.href = href;
                                navLink.className = 'nav-link nav-button';
                                navLink.textContent = item.title.toUpperCase();

                                // Add click handler
                                navLink.addEventListener('click', function (e) {
                                    if (item.linkType === 'EXTERNAL') {
                                        // External links open in new tab
                                        e.preventDefault();
                                        window.open(href, '_blank');
                                    }
                                });

                                navItem.appendChild(navLink);
                            }

                            navList.appendChild(navItem);
                        });
                    }
                } catch (error) {
                    console.error('Error loading header bottom content:', error);
                }
            }

            // Load sub-categories for a category dropdown
            async function loadSubCategories(navItem, parentItem) {
                try {
                    const dropdownMenu = navItem.querySelector('.category-dropdown-menu');
                    dropdownMenu.innerHTML = '';

                    // Use sub-items from parentItem if available
                    if (parentItem.subItems && parentItem.subItems.length > 0) {
                        parentItem.subItems.forEach(subItem => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.className = 'dropdown-item';
                            a.href = subItem.url || '#';
                            a.textContent = subItem.title;
                            li.appendChild(a);
                            dropdownMenu.appendChild(li);
                        });
                    } else {
                        // Fallback: Load from API
                        try {
                            const response = await fetch(`/content/api/header-bottom/sub-items/${parentItem.id}`);
                            const data = await response.json();

                            if (data && data.length > 0) {
                                data.forEach(subItem => {
                                    const li = document.createElement('li');
                                    const a = document.createElement('a');
                                    a.className = 'dropdown-item';
                                    a.href = subItem.url || '#';
                                    a.textContent = subItem.title;
                                    li.appendChild(a);
                                    dropdownMenu.appendChild(li);
                                });
                            } else {
                                dropdownMenu.innerHTML = '<li><a class="dropdown-item" href="#">Không có danh mục con</a></li>';
                            }
                        } catch (apiError) {
                            console.error('Error loading sub-items from API:', apiError);
                            dropdownMenu.innerHTML = '<li><a class="dropdown-item" href="#">Lỗi tải danh mục</a></li>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading sub-categories:', error);
                    const dropdownMenu = navItem.querySelector('.category-dropdown-menu');
                    dropdownMenu.innerHTML = '<li><a class="dropdown-item" href="#">Lỗi tải danh mục</a></li>';
                }
            }
        </script>

    </header>
    <!-- Header End -->
</body>

</html>