<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments/admin-head :: admin-head('Th·ªëng k√™ chi ti·∫øt - Liora Admin')}"></head>

<body class="with-welcome-text">
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
        <div th:replace="~{admin/layout/admin-navbar}"></div>
        <div th:replace="~{admin/layout/admin-sidebar}"></div>

        <div class="main-panel">
            <div class="content-wrapper">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="home-tab">
                            <div class="d-sm-flex align-items-center justify-content-between border-bottom">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active ps-0" id="revenue-tab" data-bs-toggle="tab"
                                           href="#revenue" role="tab" aria-controls="revenue"
                                           aria-selected="true">üìä Th·ªëng k√™ doanh thu</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="customers-tab" data-bs-toggle="tab"
                                           href="#customers" role="tab" aria-controls="customers"
                                           aria-selected="false">üë• Th·ªëng k√™ kh√°ch h√†ng</a>
                                    </li>
                                </ul>
                                <div class="d-flex gap-2 mb-2">
                                    <button id="exportExcel" class="btn btn-outline-success btn-sm">
                                        <i class="mdi mdi-file-excel"></i> Xu·∫•t Excel
                                    </button>
                                    <button id="exportPDF" class="btn btn-outline-danger btn-sm">
                                        <i class="mdi mdi-file-pdf"></i> Xu·∫•t PDF
                                    </button>
                                </div>
                            </div>



                            <div class="tab-content tab-content-basic mt-3">
                                <!-- ====================== TAB TH·ªêNG K√ä DOANH THU ====================== -->
                                <div class="tab-pane fade show active" id="revenue" role="tabpanel" aria-labelledby="revenue-tab">
                                    <!-- Statistics Cards -->
                                        <div th:replace="~{admin/analytics/components/statistics-cards}"></div>
                                    
                                    <!-- BI·ªÇU ƒê·ªí DOANH THU -->
                                    <div class="card card-rounded shadow-sm mb-4">
                                        <div class="card-body">
                                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                                <h4 class="card-title card-title-dash mb-2">
                                                    üìä Bi·ªÉu ƒê·ªì Doanh Thu
                                                </h4>

                                                <div class="d-flex flex-wrap align-items-center gap-2">
                                                    <!-- Input th·ªùi gian -->
                                                    <input type="date" id="startDate" class="form-control form-control-sm" style="width:150px;" max="">
                                                    <input type="date" id="endDate" class="form-control form-control-sm" style="width:150px;" max="">

                                                    <!-- Ch·ªçn nh√≥m -->
                                                    <select id="groupType" class="form-select form-select-sm bg-white text-dark border-secondary"
                                                            style="width:100px;">
                                                        <option value="day" selected>Ng√†y</option>
                                                        <option value="month">Th√°ng</option>
                                                        <option value="year">NƒÉm</option>
                                                    </select>

                                                    <!-- N√∫t ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì -->
                                                    <div class="btn-group" role="group">
                                                        <button id="btnTime" class="btn btn-outline-primary btn-sm active">Theo th·ªùi gian</button>
                                                        <button id="btnCategory" class="btn btn-outline-success btn-sm">Theo danh m·ª•c</button>
                                                        <button id="btnBrand" class="btn btn-outline-warning btn-sm">Theo th∆∞∆°ng hi·ªáu</button>
                                                    </div>

                                                    <!-- N√∫t c·∫≠p nh·∫≠t -->
                                                    <button id="refreshChart" class="btn btn-outline-secondary btn-sm">
                                                        <i class="mdi mdi-refresh"></i> C·∫≠p nh·∫≠t
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="chartjs-bar-wrapper mt-3" style="height: 420px;">
                                                <canvas id="analyticsRevenueChart"></canvas>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ƒê∆°n h√†ng g·∫ßn ƒë√¢y -->
                                    <div class="row">
                                        <div class="col-lg-12 mb-4">
                                            <div th:replace="~{admin/analytics/components/recent-orders}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- S·∫£n ph·∫©m b√°n ch·∫°y & s·∫Øp h·∫øt h√†ng -->
                                    <div class="row">
                                        <div class="col-lg-12 mb-4">
                                            <div th:replace="~{admin/analytics/components/top-products}"></div>
                                        </div>
                                    </div>

                                </div> <!-- end revenue tab -->
                                
                                <!-- ====================== TAB TH·ªêNG K√ä KH√ÅCH H√ÄNG ====================== -->
                                <div class="tab-pane fade" id="customers" role="tabpanel" aria-labelledby="customers-tab">
                                    <!-- Fragment content -->
                                    <div th:replace="~{admin/analytics/components/customers :: customers-statistics}"></div>
                                </div> <!-- end customers tab -->

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:replace="~{admin/layout/admin-footer}"></div>
        </div>
    </div>
</div>

<div th:replace="~{admin/fragments/admin-scripts :: admin-scripts}"></div>

<!-- ================= CUSTOM SCRIPT ================= -->
<!-- Th∆∞ vi·ªán xu·∫•t Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Th∆∞ vi·ªán xu·∫•t PDF (html2pdf + html2canvas + jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Custom CSS cho tabs -->
<style>
    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: #495057;
        border-bottom-color: #dee2e6;
    }
    
    .nav-tabs .nav-link.active {
        color: #5ab2ff;
        border-bottom-color: #5ab2ff;
        background-color: transparent;
    }
    
    .tab-content {
        animation: fadeIn 0.4s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .card-title-dash {
        font-size: 1.1rem;
    }
</style>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("analyticsRevenueChart").getContext("2d");
        let chart;
        let currentType = "time";

        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        document.getElementById("startDate").value = sevenDaysAgo.toISOString().split("T")[0];
        document.getElementById("endDate").value = today.toISOString().split("T")[0];

// G√°n max cho input (kh√¥ng v∆∞·ª£t h√¥m nay)
        const todayStr = today.toISOString().split("T")[0];
        document.getElementById("startDate").setAttribute("max", todayStr);
        document.getElementById("endDate").setAttribute("max", todayStr);


        const endInputEl = document.getElementById("endDate");
        if (new Date(endInputEl.value) > today) {
            endInputEl.value = todayStr;
        }

        async function loadChart() {
            const groupType = document.getElementById("groupType").value;
            const startInput = document.getElementById("startDate").value;
            const endInput = document.getElementById("endDate").value;
            let startDate, endDate;
            let labels = [];
            let values = [];

            // N·∫øu ch∆∞a ch·ªçn, m·∫∑c ƒë·ªãnh 7 ng√†y g·∫ßn nh·∫•t
            if (!startInput || !endInput) {
                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - 7);
                startDate = `${start.toISOString().split("T")[0]}T00:00:00`;
                endDate = `${end.toISOString().split("T")[0]}T23:59:59`;
                document.getElementById("startDate").value = start.toISOString().split("T")[0];
                document.getElementById("endDate").value = end.toISOString().split("T")[0];
            } else {
                startDate = `${startInput}T00:00:00`;
                endDate = `${endInput}T23:59:59`;
            }

            // R√†ng bu·ªôc ng√†y
            if (new Date(startInput) > new Date(endInput)) {
                alert("‚õî Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                return;
            }

            // L·∫•y d·ªØ li·ªáu
            const url = `/admin/revenue?type=${currentType}&groupType=${groupType}&startDate=${startDate}&endDate=${endDate}`;
            const res = await fetch(url);
            const data = await res.json();
            console.log("üëâ groupType:", groupType, "data:", data);


            // === X·ª¨ L√ù D·ªÆ LI·ªÜU ===
            if (currentType === "time") {
                const filledData = {};
                const start = new Date(startInput);
                const end = new Date(endInput);
                end.setHours(23, 59, 59, 999);

                if (groupType === "day") {
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const key = d.toLocaleDateString("en-CA");
                        filledData[key] = data[key] || 0;
                    }
                } else if (groupType === "month") {
                    const startMonth = new Date(start.getFullYear(), start.getMonth(), 1);
                    const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
                    for (let m = new Date(startMonth); m <= endMonth; m.setMonth(m.getMonth() + 1)) {
                        const key = `${m.getFullYear()}-${String(m.getMonth() + 1).padStart(2, "0")}`;

                        // t√¨m key d·∫°ng "Th√°ng 10", "T10", "10", v.v.
                        const monthName = `Th√°ng ${m.getMonth() + 1}`;
                        const foundKey = Object.keys(data).find(k =>
                            k === key ||
                            k === monthName ||
                            k.endsWith(monthName) ||
                            k.includes(monthName) ||
                            k === `${m.getMonth() + 1}/${m.getFullYear()}`
                        );

                        filledData[key] = foundKey ? data[foundKey] : 0;
                    }
                }
                else if (groupType === "year") {
                    for (let y = start.getFullYear(); y <= end.getFullYear(); y++) {
                        const foundKey = Object.keys(data).find(k => k === String(y) || k.includes(y));
                        filledData[y] = foundKey ? data[foundKey] : 0;
                    }
                }

                labels = Object.keys(filledData);
                values = Object.values(filledData);
            } else {
                // ‚úÖ category / brand
                labels = Object.keys(data);
                values = Object.values(data);
            }

            // === V·∫º BI·ªÇU ƒê·ªí ===
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: currentType === "time" ? "line" : "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Doanh thu (‚Ç´)",
                        data: values,
                        backgroundColor:
                            currentType === "brand" ? "rgba(255, 206, 86, 0.5)" :
                                currentType === "category" ? "rgba(75, 192, 192, 0.5)" :
                                    "rgba(54, 162, 235, 0.3)",
                        borderColor: "rgb(54, 162, 235)",
                        borderWidth: 2,
                        fill: currentType === "time",
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: val => val.toLocaleString("vi-VN") + " ‚Ç´" }
                        },
                        x: {
                            ticks: {
                                callback: (value, index) => {
                                    const label = labels[index];
                                    if (currentType === "time" && groupType === "day") {
                                        const d = new Date(label);
                                        return `${d.getDate()}/${d.getMonth() + 1}`;
                                    }
                                    if (currentType === "time" && groupType === "month") {
                                        const [year, month] = label.split("-");
                                        return `T${month}/${year}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: "top" },
                        tooltip: {
                            callbacks: {
                                label: ctx => "Doanh thu: " + ctx.parsed.y.toLocaleString("vi-VN") + " ‚Ç´"
                            }
                        }
                    }
                }
            });
        }

        // S·ª± ki·ªán
        document.getElementById("btnTime").addEventListener("click", () => switchType("btnTime", "time"));
        document.getElementById("btnCategory").addEventListener("click", () => switchType("btnCategory", "category"));
        document.getElementById("btnBrand").addEventListener("click", () => switchType("btnBrand", "brand"));
        document.getElementById("refreshChart").addEventListener("click", loadChart);
        document.getElementById("groupType").addEventListener("change", () => {
            if (currentType === "time") loadChart();
        });

        function switchType(id, type) {
            currentType = type;
            document.querySelectorAll(".btn-group button").forEach(btn => btn.classList.remove("active"));
            document.getElementById(id).classList.add("active");
            loadChart();
        }

        loadChart();// M·∫∑c ƒë·ªãnh khi m·ªü trang

        // ====== XU·∫§T TO√ÄN TRANG TH·ªêNG K√ä (C·∫¢I TI·∫æN) ======
        document.getElementById("exportExcel").addEventListener("click", function () {
            try {
                const now = new Date();
                const dateStr = now.toLocaleDateString('vi-VN');
                const fileName = `BaoCao_Thong_Ke_Liora_${now.toISOString().split("T")[0]}.xlsx`;
                
                // ===== T·∫†O WORKBOOK =====
                const wb = XLSX.utils.book_new();
                
                // ===== SHEET 1: T·ªîNG QUAN =====
                const overviewData = [];
                
                // Header
                overviewData.push(['B√ÅO C√ÅO TH·ªêNG K√ä T·ªîNG QUAN - LIORA BEAUTY']);
                overviewData.push([`Ng√†y xu·∫•t: ${dateStr}`]);
                overviewData.push([]); // D√≤ng tr·ªëng
                
                // Th·ªëng k√™ ch√≠nh (l·∫•y t·ª´ statistics cards)
                overviewData.push(['CH·ªà S·ªê CH√çNH']);
                overviewData.push(['STT', 'Ch·ªâ ti√™u', 'Gi√° tr·ªã']);
                
                // L·∫•y t·ª´ c√°c th·∫ª card statistics
                const statCards = document.querySelectorAll('.border-left-primary, .border-left-success, .border-left-info, .border-left-warning');
                const stats = [];
                
                statCards.forEach((card, idx) => {
                    const title = card.querySelector('.text-uppercase')?.innerText.trim() || 'N/A';
                    const value = card.querySelector('span, .h5')?.innerText.trim() || 'N/A';
                    stats.push([idx + 1, title, value]);
                });
                
                // N·∫øu kh√¥ng t√¨m th·∫•y cards, th·ª≠ l·∫•y t·ª´ statistics section kh√°c
                if (stats.length === 0) {
                    stats.push(
                        ['1', 'T·ªïng doanh thu', document.body.innerText.match(/T·ªïng doanh thu[\s\S]*?(\d[\d,. ]+‚Ç´)/)?.[1] || 'N/A'],
                        ['2', 'T·ªïng ƒë∆°n h√†ng', document.body.innerText.match(/T·ªïng ƒë∆°n h√†ng[\s\S]*?(\d+)/)?.[1] || 'N/A'],
                        ['3', 'T·ªïng s·∫£n ph·∫©m', document.body.innerText.match(/T·ªïng s·∫£n ph·∫©m[\s\S]*?(\d+)/)?.[1] || 'N/A'],
                        ['4', 'T·ªïng th∆∞∆°ng hi·ªáu', document.body.innerText.match(/T·ªïng th∆∞∆°ng hi·ªáu[\s\S]*?(\d+)/)?.[1] || 'N/A']
                    );
                }
                
                stats.forEach(row => overviewData.push(row));
                
                // Th√™m th·ªëng k√™ kh√°ch h√†ng n·∫øu c√≥
                const newCustomers = document.querySelector('.text-primary.fw-bold')?.innerText.trim();
                const returningRate = document.querySelector('.text-success.fw-bold')?.innerText.trim();
                
                if (newCustomers || returningRate) {
                    overviewData.push([]);
                    overviewData.push(['TH·ªêNG K√ä KH√ÅCH H√ÄNG']);
                    if (newCustomers) overviewData.push(['', 'Kh√°ch h√†ng m·ªõi trong th√°ng', newCustomers]);
                    if (returningRate) overviewData.push(['', 'T·ª∑ l·ªá kh√°ch quay l·∫°i', returningRate]);
                }
                
                const ws1 = XLSX.utils.aoa_to_sheet(overviewData);
                
                // Format Sheet 1 - ƒê·ªô r·ªông c·ªôt
                ws1['!cols'] = [
                    { wch: 8 },  // STT
                    { wch: 35 }, // Ch·ªâ ti√™u
                    { wch: 30 }  // Gi√° tr·ªã
                ];
                
                // Merge cells cho header v√† section titles
                const merges = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }, // Title
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 2 } }, // Date
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 2 } }  // "CH·ªà S·ªê CH√çNH"
                ];
                
                // T√¨m v·ªã tr√≠ c·ªßa "TH·ªêNG K√ä KH√ÅCH H√ÄNG" n·∫øu c√≥
                const customerStatsRow = overviewData.findIndex(row => row[0] === 'TH·ªêNG K√ä KH√ÅCH H√ÄNG');
                if (customerStatsRow > 0) {
                    merges.push({ s: { r: customerStatsRow, c: 0 }, e: { r: customerStatsRow, c: 2 } });
                }
                
                ws1['!merges'] = merges;
                
                XLSX.utils.book_append_sheet(wb, ws1, "T·ªïng quan");
                
                // ===== SHEET 2: DOANH THU THEO TH·ªúI GIAN =====
                if (chart && chart.data) {
                    const revenueData = [];
                    revenueData.push(['DOANH THU THEO TH·ªúI GIAN']);
                    revenueData.push([]);
                    revenueData.push(['STT', 'Th·ªùi gian', 'Doanh thu (‚Ç´)']);
                    
                    chart.data.labels.forEach((label, idx) => {
                        revenueData.push([
                            idx + 1,
                            label,
                            chart.data.datasets[0].data[idx].toLocaleString('vi-VN')
                        ]);
                    });
                    
                    // T·ªïng c·ªông
                    const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                    revenueData.push([]);
                    revenueData.push(['', 'T·ªîNG C·ªòNG:', total.toLocaleString('vi-VN') + ' ‚Ç´']);
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(revenueData);
                    ws2['!cols'] = [
                        { wch: 8 },
                        { wch: 20 },
                        { wch: 25 }
                    ];
                    ws2['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws2, "Doanh thu");
                }
                
                // ===== SHEET 3: ƒê∆†N H√ÄNG G·∫¶N ƒê√ÇY =====
                const ordersTable = document.querySelector('.card-body table');
                if (ordersTable) {
                    const ordersData = [];
                    ordersData.push(['ƒê∆†N H√ÄNG G·∫¶N ƒê√ÇY']);
                    ordersData.push([]);
                    
                    // Headers v·ªõi STT
                    const headers = ['STT'];
                    ordersTable.querySelectorAll('thead th').forEach(th => {
                        headers.push(th.innerText.trim());
                    });
                    ordersData.push(headers);
                    
                    // Data rows
                    ordersTable.querySelectorAll('tbody tr').forEach((tr, idx) => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length > 0 && !tr.innerText.includes('Kh√¥ng c√≥')) {
                            const row = [idx + 1];
                            tds.forEach(td => {
                                row.push(td.innerText.trim());
                            });
                            ordersData.push(row);
                        }
                    });
                    
                    const ws3 = XLSX.utils.aoa_to_sheet(ordersData);
                    ws3['!cols'] = [
                        { wch: 5 },  // STT
                        { wch: 10 }, // ID
                        { wch: 20 }, // Kh√°ch h√†ng
                        { wch: 15 }, // Ng√†y ƒë·∫∑t
                        { wch: 20 }, // T·ªïng ti·ªÅn
                        { wch: 15 }  // Tr·∫°ng th√°i
                    ];
                    ws3['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws3, "ƒê∆°n h√†ng g·∫ßn ƒë√¢y");
                }
                
                // ===== SHEET 4: TOP S·∫¢N PH·∫®M B√ÅN CH·∫†Y =====
                const topProductsTable = document.querySelector('.card-header .text-primary')?.closest('.card')?.querySelector('table');
                if (topProductsTable) {
                    const productsData = [];
                    productsData.push(['TOP S·∫¢N PH·∫®M B√ÅN CH·∫†Y']);
                    productsData.push([]);
                    productsData.push(['STT', 'ID', 'T√™n s·∫£n ph·∫©m', 'Danh m·ª•c', 'ƒê√£ b√°n', 'Doanh thu', 'ƒê√°nh gi√°']);
                    
                    let productIndex = 0;
                    topProductsTable.querySelectorAll('tbody tr').forEach((tr) => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length > 0 && !tr.innerText.includes('Kh√¥ng c√≥') && !tr.innerText.includes('Ch∆∞a c√≥')) {
                            // L·∫•y s·ªë l∆∞·ª£ng ƒë√£ b√°n (c·ªôt th·ª© 4)
                            const soldQty = parseInt(tds[3].innerText.trim()) || 0;
                            
                            // Ch·ªâ xu·∫•t s·∫£n ph·∫©m c√≥ l∆∞·ª£t b√°n > 0
                            if (soldQty > 0) {
                                productIndex++;
                                const row = [
                                    productIndex,
                                    tds[0].innerText.trim(), // ID
                                    tds[1].innerText.trim(), // T√™n
                                    tds[2].innerText.trim(), // Danh m·ª•c
                                    tds[3].innerText.trim(), // ƒê√£ b√°n
                                    tds[4].innerText.trim(), // Doanh thu
                                    tds[5].innerText.trim()  // ƒê√°nh gi√°
                                ];
                                productsData.push(row);
                            }
                        }
                    });
                    
                    const ws4 = XLSX.utils.aoa_to_sheet(productsData);
                    ws4['!cols'] = [
                        { wch: 5 },  // STT
                        { wch: 8 },  // ID
                        { wch: 30 }, // T√™n
                        { wch: 20 }, // Danh m·ª•c
                        { wch: 10 }, // ƒê√£ b√°n
                        { wch: 20 }, // Doanh thu
                        { wch: 10 }  // Rating
                    ];
                    ws4['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws4, "S·∫£n ph·∫©m b√°n ch·∫°y");
                }
                
                // ===== SHEET 5: S·∫¢N PH·∫®M S·∫ÆP H·∫æT H√ÄNG =====
                const lowStockTable = document.querySelector('.card-header .text-danger')?.closest('.card')?.querySelector('table');
                if (lowStockTable) {
                    const lowStockData = [];
                    lowStockData.push(['S·∫¢N PH·∫®M S·∫ÆP H·∫æT H√ÄNG']);
                    lowStockData.push([]);
                    lowStockData.push(['STT', 'ID', 'T√™n s·∫£n ph·∫©m', 'Danh m·ª•c', 'T·ªìn kho', 'Tr·∫°ng th√°i']);
                    
                    lowStockTable.querySelectorAll('tbody tr').forEach((tr, idx) => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length > 0 && !tr.innerText.includes('Kh√¥ng c√≥')) {
                            const row = [
                                idx + 1,
                                tds[0].innerText.trim(), // ID
                                tds[1].innerText.trim(), // T√™n
                                tds[2].innerText.trim(), // Danh m·ª•c
                                tds[3].innerText.trim(), // T·ªìn kho
                                tds[4].innerText.trim()  // Tr·∫°ng th√°i
                            ];
                            lowStockData.push(row);
                        }
                    });
                    
                    const ws5 = XLSX.utils.aoa_to_sheet(lowStockData);
                    ws5['!cols'] = [
                        { wch: 5 },  // STT
                        { wch: 8 },  // ID
                        { wch: 30 }, // T√™n
                        { wch: 20 }, // Danh m·ª•c
                        { wch: 15 }, // T·ªìn kho
                        { wch: 12 }  // Tr·∫°ng th√°i
                    ];
                    ws5['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws5, "S·∫£n ph·∫©m s·∫Øp h·∫øt");
                }
                
                // ===== SHEET 6: TOP KH√ÅCH H√ÄNG =====
                const customersTable = document.querySelector('.card-header .text-warning')?.closest('.card')?.querySelector('table');
                if (customersTable) {
                    const customersData = [];
                    customersData.push(['TOP KH√ÅCH H√ÄNG CHI TI√äU NHI·ªÄU NH·∫§T']);
                    customersData.push([]);
                    customersData.push(['STT', 'ID', 'T√™n kh√°ch h√†ng', 'Email', 'S·ªë ƒë∆°n h√†ng', 'T·ªïng chi ti√™u']);
                    
                    customersTable.querySelectorAll('tbody tr').forEach((tr, idx) => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length > 0 && !tr.innerText.includes('Kh√¥ng c√≥')) {
                            const row = [
                                idx + 1,
                                tds[0].innerText.trim(), // ID
                                tds[1].innerText.trim(), // T√™n
                                tds[2].innerText.trim(), // Email
                                tds[3].innerText.trim(), // S·ªë ƒë∆°n
                                tds[4].innerText.trim()  // T·ªïng chi
                            ];
                            customersData.push(row);
                        }
                    });
                    
                    const ws6 = XLSX.utils.aoa_to_sheet(customersData);
                    ws6['!cols'] = [
                        { wch: 5 },  // STT
                        { wch: 8 },  // ID
                        { wch: 25 }, // T√™n
                        { wch: 30 }, // Email
                        { wch: 12 }, // S·ªë ƒë∆°n
                        { wch: 20 }  // T·ªïng chi
                    ];
                    ws6['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws6, "Top kh√°ch h√†ng");
                }
                
                // ===== SHEET 7: TH·ªêNG K√ä KH√ÅCH H√ÄNG CHI TI·∫æT =====
                const customerStatsData = [];
                customerStatsData.push(['TH·ªêNG K√ä KH√ÅCH H√ÄNG CHI TI·∫æT']);
                customerStatsData.push([`Ng√†y xu·∫•t: ${dateStr}`]);
                customerStatsData.push([]);
                
                // L·∫•y t·ª´ c√°c th·∫ª card trong tab kh√°ch h√†ng
                const newCustomersCard = document.querySelector('.border-primary .text-primary.fw-bold');
                const returningRateCard = document.querySelector('.border-success .text-success.fw-bold');
                const totalCustomersCard = document.querySelector('.border-warning .text-warning.fw-bold');
                
                customerStatsData.push(['CH·ªà S·ªê']);
                customerStatsData.push(['1', 'Kh√°ch h√†ng m·ªõi trong th√°ng', newCustomersCard?.innerText.trim() || 'N/A']);
                customerStatsData.push(['2', 'T·ª∑ l·ªá kh√°ch quay l·∫°i', returningRateCard?.innerText.trim() || 'N/A']);
                customerStatsData.push(['3', 'T·ªïng s·ªë kh√°ch h√†ng', totalCustomersCard?.innerText.trim() || 'N/A']);
                
                const ws7 = XLSX.utils.aoa_to_sheet(customerStatsData);
                ws7['!cols'] = [
                    { wch: 5 },
                    { wch: 35 },
                    { wch: 20 }
                ];
                
                const merges7 = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }, // Title
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 2 } }, // Date
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 2 } }  // Section title
                ];
                
                ws7['!merges'] = merges7;
                XLSX.utils.book_append_sheet(wb, ws7, "Th·ªëng k√™ kh√°ch h√†ng");
                
                // ===== XU·∫§T FILE =====
                XLSX.writeFile(wb, fileName);
                
                // Th√¥ng b√°o th√†nh c√¥ng
                alert(`‚úÖ Xu·∫•t Excel th√†nh c√¥ng!\nüìÅ File: ${fileName}`);
                
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                alert(`‚ùå L·ªói khi xu·∫•t Excel: ${error.message}`);
            }
        });

        document.getElementById("exportPDF").addEventListener("click", function () {
            // L·∫•y c√°c elements
            const tabNavigation = document.querySelector(".d-sm-flex.align-items-center.justify-content-between.border-bottom");
            const revenueTab = document.getElementById("revenue");
            const customersTab = document.getElementById("customers");
            const homeTab = document.querySelector(".home-tab");
            
            // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu
            const originalTabNavigationDisplay = tabNavigation ? tabNavigation.style.display : '';
            const revenueOriginalDisplay = revenueTab ? revenueTab.style.display : '';
            const revenueOriginalOpacity = revenueTab ? revenueTab.style.opacity : '';
            const customersOriginalDisplay = customersTab ? customersTab.style.display : '';
            const customersOriginalOpacity = customersTab ? customersTab.style.opacity : '';
            
            // ·∫®n navigation
            if (tabNavigation) tabNavigation.style.display = 'none';
            
            // Hi·ªÉn th·ªã c·∫£ 2 tab
            if (revenueTab) {
                revenueTab.style.display = 'block';
                revenueTab.style.opacity = '1';
            }
            if (customersTab) {
                customersTab.style.display = 'block';
                customersTab.style.opacity = '1';
            }
            
            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ render xong
            setTimeout(() => {
                const opt = {
                    margin:       0.3,
                    filename:     `BaoCao_Liora_${new Date().toISOString().split("T")[0]}.pdf`,
                    image:        { type: 'jpeg', quality: 0.95 },
                    html2canvas:  { 
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: true
                    },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
                };

                // Export t·ª´ home-tab
                html2pdf().set(opt).from(homeTab).save().then(() => {
                    // Restore
                    if (tabNavigation) tabNavigation.style.display = originalTabNavigationDisplay;
                    if (revenueTab) {
                        revenueTab.style.display = revenueOriginalDisplay;
                        revenueTab.style.opacity = revenueOriginalOpacity;
                    }
                    if (customersTab) {
                        customersTab.style.display = customersOriginalDisplay;
                        customersTab.style.opacity = customersOriginalOpacity;
                    }
                }).catch((error) => {
                    console.error('L·ªói export PDF:', error);
                    // Restore
                    if (tabNavigation) tabNavigation.style.display = originalTabNavigationDisplay;
                    if (revenueTab) {
                        revenueTab.style.display = revenueOriginalDisplay;
                        revenueTab.style.opacity = revenueOriginalOpacity;
                    }
                    if (customersTab) {
                        customersTab.style.display = customersOriginalDisplay;
                        customersTab.style.opacity = customersOriginalOpacity;
                    }
                    alert('‚ùå L·ªói khi xu·∫•t PDF!');
                });
            }, 300);
        });
    });
</script>

</body>
</html>
