<!-- Product Form -->
<form id="productForm" novalidate>
    <!-- Tên sản phẩm -->
    <div class="mb-3">
        <label for="name" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="name" name="name" required>
    </div>

    <!-- Danh mục -->
    <div class="mb-3">
        <label for="categoryId" class="form-label">Danh mục <span class="text-danger">*</span></label>
        <select class="form-select" id="categoryId" name="categoryId" required>
            <option value="">Chọn danh mục</option>
            <option th:each="category : ${categories}" th:value="${category.categoryId}" th:text="${category.name}">
            </option>
        </select>
    </div>

    <!-- Thương hiệu -->
    <div class="mb-3">
        <label for="brandId" class="form-label">Thương hiệu <span class="text-danger">*</span></label>
        <select class="form-select" id="brandId" name="brandId" required>
            <option value="">Chọn thương hiệu</option>
            <option th:each="brand : ${brands}" th:value="${brand.brandId}" th:text="${brand.name}"></option>
        </select>
    </div>

    <!-- Giá bán -->
    <div class="mb-3">
        <label for="price" class="form-label">Giá bán <span class="text-danger">*</span></label>
        <div class="input-group">
            <input type="number" class="form-control" id="price" name="price" min="0" step="1000" required>
            <span class="input-group-text">₫</span>
        </div>
    </div>

    <!-- Số lượng tồn kho -->
    <div class="mb-3">
        <label for="stock" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
        <input type="number" class="form-control" id="stock" name="stock" min="0" required>
    </div>

    <!-- Mô tả -->
    <div class="mb-3">
        <label for="description" class="form-label">Mô tả chi tiết <span class="text-danger">*</span></label>
        <div class="editor-container">
            <textarea class="form-control" id="description" name="description" rows="8" required
                placeholder="Nhập mô tả chi tiết sản phẩm..."></textarea>
        </div>
        <div class="invalid-feedback">Vui lòng nhập mô tả sản phẩm</div>
    </div>

    <!-- Trạng thái -->
    <div class="mb-3">
        <h4 class="card-title card-title-dash">Trạng thái sản phẩm</h4>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="form-check ps-4">
                    <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                    <label class="form-check-label" for="isActive">Kích hoạt sản phẩm</label>
                </div>
                <small class="text-muted">Sản phẩm sẽ được kích hoạt mặc định. Trạng thái tồn kho sẽ được tự động cập
                    nhật dựa vào số lượng nhập.</small>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" onclick="window.productEditManager.refreshProduct()">Làm
            mới</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner"></span>
            <span id="submitText">Lưu sản phẩm</span>
        </button>
    </div>
</form>

<!-- CKEditor for Product Description -->
<style>
    .editor-container {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .editor-container .ck-editor,
    .editor-container .ck-editor__main,
    .editor-container .ck-content {
        width: 100% !important;
        max-width: 100% !important;
    }

    .editor-container .ck-content {
        min-height: 300px;
    }

    .ck-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }

    .ck-content table {
        width: 100%;
        border-collapse: collapse;
    }

    .ck-content table td,
    .ck-content table th {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
    }

    .ck-content blockquote {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        color: #666;
    }

    .ck.ck-editor__editable_inline:focus {
        box-shadow: none;
    }

    .ck.ck-editor {
        border: none;
    }

    .ck.ck-toolbar {
        border-bottom: 1px solid #e9ecef;
    }
</style>

<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
    (function initProductDescriptionEditor() {
        const textarea = document.getElementById('description');
        if (!textarea) return;

        let editorInstance;

        class UploadAdapter {
            constructor(loader) { this.loader = loader; }
            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file, file.name);
                    fetch('/admin/api/upload/image', { method: 'POST', body: formData })
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.success && data.url) {
                                resolve({ default: data.url });
                            } else {
                                reject(data && data.message ? data.message : 'Upload failed');
                            }
                        })
                        .catch(err => reject(err));
                }));
            }
            abort() { /* no-op */ }
        }

        function UploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = loader => new UploadAdapter(loader);
        }

        ClassicEditor.create(textarea, {
            extraPlugins: [UploadAdapterPlugin],
            toolbar: {
                items: [
                    'undo', 'redo', '|', 'heading', '|', 'bold', 'italic', 'link', '|',
                    'bulletedList', 'numberedList', 'outdent', 'indent', '|',
                    'insertTable', 'imageUpload', 'blockQuote', 'mediaEmbed'
                ]
            }
        }).then(editor => {
            editorInstance = editor;
            window.productDescriptionEditor = editor;

            // Nếu textarea có giá trị sẵn (trang edit), set vào editor
            const initial = textarea.value && textarea.value.trim();
            if (initial) {
                try { editor.setData(initial); } catch (_) { }
            }
        }).catch(err => console.error('[CKEditor][Product Description] init error:', err));
    })();
</script>