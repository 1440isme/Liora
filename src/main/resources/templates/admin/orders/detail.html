<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/admin-head :: admin-head('Chi tiết đơn hàng - Liora Admin')"></head>

<body class="with-welcome-text">
    <div class="container-scroller">
        <div class="container-fluid page-body-wrapper">
            <div th:replace="admin/layout/admin-navbar"></div>
            <div th:replace="admin/layout/admin-sidebar"></div>

            <div class="main-panel">
                <div class="content-wrapper">
                    <!-- Page Header -->
                    <div class="d-sm-flex align-items-center justify-content-between border-bottom mb-3">
                        <h1 class="h3 mb-0">Chi tiết đơn hàng #<span th:text="${order.id}">12345</span></h1>
                        <div class="btn-wrapper">
                            <a href="/admin/orders" class="btn btn-otline-dark me-2"><i class="mdi mdi-arrow-left"></i>
                                Quay lại</a>
                            <button type="button" class="btn btn-otline-dark me-2" onclick="window.print()"><i
                                    class="mdi mdi-printer"></i> In đơn hàng</button>
                            <button type="button" class="btn btn-primary text-white" data-bs-toggle="modal"
                                data-bs-target="#updateStatusModal"><i class="mdi mdi-pencil"></i> Cập nhật trạng
                                thái</button>
                        </div>
                    </div>

                    <div class="card card-rounded mb-4">
                        <div class="card-body">
                            <h4 class="card-title card-title-dash">Trạng thái đơn hàng</h4>
                            <div th:replace="admin/orders/components/order-status"></div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Order Information -->
                        <div class="col-lg-8">
                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Thông tin khách hàng</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Thông tin liên hệ</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td><strong>Họ tên:</strong></td>
                                                    <td th:text="${order.customerName}">Nguyễn Văn A</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Email:</strong></td>
                                                    <td th:text="${order.customerEmail}">customer@example.com</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Số điện thoại:</strong></td>
                                                    <td th:text="${order.customerPhone}">0123456789</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Địa chỉ giao hàng</h6>
                                            <address th:text="${order.shippingAddress}">
                                                123 Đường ABC, Quận XYZ, TP.HCM
                                            </address>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Sản phẩm trong đơn hàng</h4>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Hình ảnh</th>
                                                    <th>Tên sản phẩm</th>
                                                    <th>SKU</th>
                                                    <th>Giá</th>
                                                    <th>Số lượng</th>
                                                    <th>Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="item : ${order.orderItems}">
                                                    <td>
                                                        <img th:src="${item.productImageUrl}"
                                                            th:alt="${item.productName}" class="img-thumbnail"
                                                            width="50" height="50" style="object-fit: cover;">
                                                    </td>
                                                    <td th:text="${item.productName}">Tên sản phẩm</td>
                                                    <td th:text="${item.productSku}">SKU123</td>
                                                    <td
                                                        th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                        1,000,000 ₫</td>
                                                    <td th:text="${item.quantity}">2</td>
                                                    <td
                                                        th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                        2,000,000 ₫</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Ghi chú đơn hàng</h4>
                                    <div th:if="${order.notes != null and !order.notes.isEmpty()}">
                                        <p th:text="${order.notes}">Ghi chú từ khách hàng</p>
                                    </div>
                                    <div th:if="${order.notes == null or order.notes.isEmpty()}" class="text-muted">
                                        Không có ghi chú
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-4">
                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Tóm tắt đơn hàng</h4>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Mã đơn hàng:</strong></td>
                                            <td th:text="'#' + ${order.id}">#12345</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Ngày đặt:</strong></td>
                                            <td th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">
                                                15/12/2024 10:30</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Trạng thái:</strong></td>
                                            <td>
                                                <span class="badge"
                                                    th:classappend="${order.status == 'PENDING'} ? 'bg-warning' : 
                                                                 (${order.status == 'CONFIRMED'} ? 'bg-info' : 
                                                                 (${order.status == 'SHIPPED'} ? 'bg-primary' : 
                                                                 (${order.status == 'DELIVERED'} ? 'bg-success' : 'bg-danger')))"
                                                    th:text="${order.status}">Đang xử lý</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Thanh toán:</strong></td>
                                            <td>
                                                <span class="badge"
                                                    th:classappend="${order.paymentStatus == 'PAID'} ? 'bg-success' : 
                                                                 (${order.paymentStatus == 'PENDING'} ? 'bg-warning' : 'bg-danger')"
                                                    th:text="${order.paymentStatus}">Chờ thanh toán</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Phương thức thanh toán:</strong></td>
                                            <td th:text="${order.paymentMethod}">Chuyển khoản</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Phí vận chuyển:</strong></td>
                                            <td
                                                th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                30,000 ₫</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Giảm giá:</strong></td>
                                            <td
                                                th:text="${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫</td>
                                        </tr>
                                        <tr class="table-success">
                                            <td><strong>Tổng tiền:</strong></td>
                                            <td class="fw-bold"
                                                th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                2,030,000 ₫</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Thông tin vận chuyển</h4>
                                    <div th:if="${order.shippingInfo != null}">
                                        <p><strong>Đơn vị vận chuyển:</strong> <span
                                                th:text="${order.shippingInfo.carrier}">Viettel Post</span></p>
                                        <p><strong>Mã vận đơn:</strong> <span
                                                th:text="${order.shippingInfo.trackingNumber}">VT123456789</span></p>
                                        <p><strong>Ngày giao hàng dự kiến:</strong> <span
                                                th:text="${#temporals.format(order.shippingInfo.estimatedDelivery, 'dd/MM/yyyy')}">20/12/2024</span>
                                        </p>
                                    </div>
                                    <div th:if="${order.shippingInfo == null}" class="text-muted">
                                        Chưa có thông tin vận chuyển
                                    </div>
                                </div>
                            </div>

                            <div class="card card-rounded mb-4">
                                <div class="card-body">
                                    <h4 class="card-title card-title-dash">Thao tác</h4>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary text-white" data-bs-toggle="modal"
                                            data-bs-target="#updateStatusModal">
                                            <i class="mdi mdi-pencil"></i> Cập nhật trạng thái
                                        </button>
                                        <button type="button" class="btn btn-otline-dark" onclick="window.print()">
                                            <i class="mdi mdi-printer"></i> In đơn hàng
                                        </button>
                                        <a th:href="'mailto:' + ${order.customerEmail}" class="btn btn-success">
                                            <i class="mdi mdi-email-outline"></i> Gửi email
                                        </a>
                                        <button type="button" class="btn btn-warning" data-bs-toggle="modal"
                                            data-bs-target="#addNoteModal">
                                            <i class="mdi mdi-note-plus-outline"></i> Thêm ghi chú
                                        </button>
                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                            data-bs-target="#cancelOrderModal">
                                            <i class="mdi mdi-close"></i> Hủy đơn hàng
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:replace="admin/layout/admin-footer"></div>
                </div>
            </div>
        </div>

        <!-- Update Status Modal -->
        <div class="modal fade" id="updateStatusModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Cập nhật trạng thái đơn hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/admin/orders/{id}/status(id=${order.id})}" method="post">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="newStatus" class="form-label">Trạng thái mới</label>
                                <select class="form-select" id="newStatus" name="status" required>
                                    <option value="PENDING" th:selected="${order.status == 'PENDING'}">Chờ xử lý
                                    </option>
                                    <option value="CONFIRMED" th:selected="${order.status == 'CONFIRMED'}">Đã xác nhận
                                    </option>
                                    <option value="SHIPPED" th:selected="${order.status == 'SHIPPED'}">Đang giao
                                    </option>
                                    <option value="DELIVERED" th:selected="${order.status == 'DELIVERED'}">Đã giao
                                    </option>
                                    <option value="CANCELLED" th:selected="${order.status == 'CANCELLED'}">Đã hủy
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="statusNote" class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="statusNote" name="note" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                            <button type="submit" class="btn btn-primary">Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Note Modal -->
        <div class="modal fade" id="addNoteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Thêm ghi chú</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/admin/orders/{id}/note(id=${order.id})}" method="post">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="note" class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="note" name="note" rows="4" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                            <button type="submit" class="btn btn-primary">Thêm ghi chú</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Cancel Order Modal -->
        <div class="modal fade" id="cancelOrderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hủy đơn hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/admin/orders/{id}/cancel(id=${order.id})}" method="post">
                        <div class="modal-body">
                            <p>Bạn có chắc chắn muốn hủy đơn hàng này?</p>
                            <div class="mb-3">
                                <label for="cancelReason" class="form-label">Lý do hủy</label>
                                <textarea class="form-control" id="cancelReason" name="reason" rows="3"
                                    required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                            <button type="submit" class="btn btn-danger">Xác nhận hủy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div th:replace="admin/fragments/admin-scripts :: admin-scripts"></div>
        <script src="/admin/js/admin/orders.js"></script>
</body>

</html>